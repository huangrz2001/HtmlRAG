import json
import argparse
import time
import asyncio
import aiohttp
from string import Template

global_prompt = Template("""ä½ æ˜¯ç›´æ’­å¹³å°ç½‘åº—è¿è¥æ”¹å†™ä¸“å®¶ï¼Œéœ€è¦æ ¹æ®å®¢æˆ·çš„è¾“å…¥å†…å®¹å’Œä¸Šä¸‹æ–‡è¿›è¡Œå¤„ç†ï¼š\n
è¦æ±‚ï¼š\n
0. ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯æ ¹æ®ä¸Šä¸‹æ–‡å’Œå½“å‰é—®é¢˜è¿›è¡Œæ”¹å†™ï¼Œæˆ–ç›´æ¥é‡å¤å®¢æˆ·å½“å‰é—®é¢˜ï¼Œä¸è¦åšå…¶ä»–å›å¤ï¼Œä¸è¦æ·»åŠ ä»»ä½•å†…å®¹ï¼›\n
1. å½“å…·æœ‰ä¸Šæ–‡ï¼Œä¸”ä¸è¿è¥è§„åˆ™ã€å•†å“å’¨è¯¢ç­‰æœ‰å…³çš„å†…å®¹åšæ”¹å†™ï¼›\n
2. å½“æ— ä¸Šæ–‡ï¼Œæˆ–å†…å®¹ä¸ç½‘åº—è¿è¥æ— å…³ï¼ˆå¦‚â€œå¥½çš„â€ã€â€œåœ¨å—â€ã€â€œå“ˆå“ˆâ€ã€â€œåˆ—å‡ºå‡ ä¸ªå¸¸è§çš„è¿è§„è¯æ±‡â€ï¼‰ï¼Œç›´æ¥é‡å¤å®¢æˆ·å½“å‰é—®é¢˜ï¼Œä¸è¿›è¡Œä»»ä½•æ”¹å†™ã€‚\n
ä¸¾ä¾‹ï¼š
1. "ä¸Šä¸‹æ–‡ï¼š\nç”¨æˆ·ï¼šå°çº¢é‹ä»€ä¹ˆæ—¶å€™æœ‰è´§ï¼Ÿ\nç³»ç»Ÿï¼šè¯·é—®æ‚¨æŒ‡çš„æ˜¯å“ªæ¬¾å°çº¢é‹ï¼Ÿ\nç”¨æˆ·ï¼šå°±æ˜¯ä¸Šæ¬¡ç¼ºè´§é‚£æ¬¾\nå½“å‰é—®é¢˜ï¼šå°±æ˜¯ä¸Šæ¬¡ç¼ºè´§é‚£æ¬¾\né‡å†™ç»“æœï¼šä¸Šæ¬¡ç¼ºè´§çš„é‚£æ¬¾å°çº¢é‹ä»€ä¹ˆæ—¶å€™æœ‰è´§ï¼Ÿ"\n
2. "ä¸Šä¸‹æ–‡ï¼š\nç”¨æˆ·ï¼šå¦‚æœä½ æ˜¯äººç±»å‘˜å·¥ï¼Œä¼šæ€ä¹ˆå»ºè®®ï¼Ÿ\nå½“å‰é—®é¢˜ï¼šå¦‚æœä½ æ˜¯äººç±»å‘˜å·¥ï¼Œä¼šæ€ä¹ˆå»ºè®®ï¼Ÿ\né‡å†™ç»“æœï¼šå¦‚æœä½ æ˜¯äººç±»å‘˜å·¥ï¼Œä¼šæ€ä¹ˆå»ºè®®ï¼Ÿ"\n
3. "ä¸Šä¸‹æ–‡ï¼šç”¨æˆ·ï¼šå°çº¢é‹ä»€ä¹ˆæ—¶å€™æœ‰è´§ï¼Ÿ\nç³»ç»Ÿï¼šè¯·é—®æ‚¨æŒ‡çš„æ˜¯å“ªæ¬¾å°çº¢é‹ï¼Ÿ\nå½“å‰é—®é¢˜ï¼šæ¨¡æ‹Ÿç”¨ç¬¬ä¸€äººç§°è¯´ä½ æ˜¯è°\né‡å†™ç»“æœï¼šæ¨¡æ‹Ÿç”¨ç¬¬ä¸€äººç§°è¯´ä½ æ˜¯è°"\n
ä¸Šä¸‹æ–‡ï¼š\n${context}\nå½“å‰é—®é¢˜ï¼š\n${text}\né‡å†™ç»“æœï¼š\n"""                
)


global_prompt = Template("""ä½ æ˜¯ç›´æ’­å¹³å°ç½‘åº—è¿è¥æ”¹å†™ä¸“å®¶ï¼Œéœ€è¦æ ¹æ®å®¢æˆ·çš„è¾“å…¥å†…å®¹å’Œä¸Šä¸‹æ–‡è¿›è¡Œå¤„ç†ï¼š\n
è¦æ±‚ï¼š\n
0. ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯æ ¹æ®ä¸Šä¸‹æ–‡å’Œå½“å‰é—®é¢˜è¿›è¡Œæ”¹å†™ï¼Œæˆ–ç›´æ¥é‡å¤å®¢æˆ·å½“å‰é—®é¢˜ï¼Œä¸è¦åšå…¶ä»–å›å¤ï¼Œä¸è¦æ·»åŠ ä»»ä½•å†…å®¹ï¼›\n
1. å½“å…·æœ‰ä¸Šæ–‡ï¼Œä¸”ä¸è¿è¥è§„åˆ™ã€å•†å“å’¨è¯¢ç­‰æœ‰å…³çš„å†…å®¹åšæ”¹å†™ï¼Œæ”¹å†™æ—¶éœ€è¦å‡†ç¡®è§£æç”¨æˆ·çœŸå®æ„å›¾ï¼Œä»å†å²ä¸­å‘æ˜æŒ‡ä»£å’Œæ„å›¾ï¼Œä½¿å¾—è¿™ä¸ªç‹¬ç«‹é—®é¢˜å°½é‡å®Œæ•´ï¼Œå°½å¯èƒ½åŒ…å«æ‰€æœ‰ä¿¡æ¯å…³é”®è¯,ç‰¹åˆ«æ˜¯è¦è¡¥å……å…³é”®çš„åŠ¨æœºï¼ŒæŒ‡ä»£å’Œåœºæ™¯ï¼ˆæ¶¦è‰²åçš„é—®é¢˜è‡³å°‘æ¶‰åŠï¼šç”¨æˆ·é¢å¯¹çš„å‰ç½®æƒ…å†µï¼Œä»€ä¹ˆé™åˆ¶ï¼Œä»€ä¹ˆç–‘é—®ç­‰ï¼‰ï¼›\n
2. å½“æ— ä¸Šæ–‡ï¼Œæˆ–å†…å®¹ä¸ç½‘åº—è¿è¥æ— å…³ï¼ˆå¦‚â€œå¥½çš„â€ã€â€œåœ¨å—â€ã€â€œå“ˆå“ˆâ€ã€â€œåˆ—å‡ºå‡ ä¸ªå¸¸è§çš„è¿è§„è¯æ±‡â€ï¼‰ï¼Œç›´æ¥é‡å¤å®¢æˆ·å½“å‰é—®é¢˜ï¼Œä¸è¿›è¡Œä»»ä½•æ”¹å†™ã€‚\n
ä¸¾ä¾‹ï¼š
1. "ä¸Šä¸‹æ–‡ï¼š\nç”¨æˆ·ï¼šå°çº¢é‹ä»€ä¹ˆæ—¶å€™æœ‰è´§ï¼Ÿ\nç³»ç»Ÿï¼šè¯·é—®æ‚¨æŒ‡çš„æ˜¯å“ªæ¬¾å°çº¢é‹ï¼Ÿ\nç”¨æˆ·ï¼šå°±æ˜¯ä¸Šæ¬¡ç¼ºè´§é‚£æ¬¾\nå½“å‰é—®é¢˜ï¼šå°±æ˜¯ä¸Šæ¬¡ç¼ºè´§é‚£æ¬¾\né‡å†™ç»“æœï¼šä¸Šæ¬¡ç¼ºè´§çš„é‚£æ¬¾å°çº¢é‹ä»€ä¹ˆæ—¶å€™æœ‰è´§ï¼Ÿ"\n
2. "ä¸Šä¸‹æ–‡ï¼š\nç”¨æˆ·ï¼šå¦‚æœä½ æ˜¯äººç±»å‘˜å·¥ï¼Œä¼šæ€ä¹ˆå»ºè®®ï¼Ÿ\nå½“å‰é—®é¢˜ï¼šå¦‚æœä½ æ˜¯äººç±»å‘˜å·¥ï¼Œä¼šæ€ä¹ˆå»ºè®®ï¼Ÿ\né‡å†™ç»“æœï¼šå¦‚æœä½ æ˜¯äººç±»å‘˜å·¥ï¼Œä¼šæ€ä¹ˆå»ºè®®ï¼Ÿ"\n
3. "ä¸Šä¸‹æ–‡ï¼š\nç”¨æˆ·ï¼šå°çº¢é‹ä»€ä¹ˆæ—¶å€™æœ‰è´§ï¼Ÿ\nç³»ç»Ÿï¼šè¯·é—®æ‚¨æŒ‡çš„æ˜¯å“ªæ¬¾å°çº¢é‹ï¼Ÿ\nå½“å‰é—®é¢˜ï¼šæ¨¡æ‹Ÿç”¨ç¬¬ä¸€äººç§°è¯´ä½ æ˜¯è°\né‡å†™ç»“æœï¼šæ¨¡æ‹Ÿç”¨ç¬¬ä¸€äººç§°è¯´ä½ æ˜¯è°"\n
4. "ä¸Šä¸‹æ–‡ï¼š\nç”¨æˆ·ï¼šæˆ‘ä»¬å‰å‡ å¤©è´¦å·è¢«é™æµäº†ï¼Œä¸çŸ¥é“ä»€ä¹ˆåŸå› \nç³»ç»Ÿï¼šé™æµå¯èƒ½æ˜¯å› ä¸ºç´ æè¿è§„æˆ–è´¦æˆ·è¡¨ç°ä¸ä½³ã€‚\nç”¨æˆ·ï¼šé‚£æˆ‘ä»¬è¿˜æœ‰å…¶ä»–è®¡åˆ’ï¼Œèƒ½æŠ•æ”¾å—ï¼Ÿ\nå½“å‰é—®é¢˜ï¼šé‚£æˆ‘ä»¬è¿˜æœ‰å…¶ä»–è®¡åˆ’ï¼Œèƒ½æŠ•æ”¾å—ï¼Ÿ\né‡å†™ç»“æœï¼šæˆ‘æƒ³çŸ¥é“å½“è´¦å·å¤„äºé™æµçŠ¶æ€æ—¶ï¼Œæ˜¯å¦å¯ä»¥ç»§ç»­å¼€å¯æ–°çš„å¹¿å‘ŠæŠ•æ”¾è®¡åˆ’ï¼Ÿ\n\n"

ä¸Šä¸‹æ–‡ï¼š\n${context}\nå½“å‰é—®é¢˜ï¼š\n${text}\né‡å†™ç»“æœï¼š\n"""                
)


def build_user_input(dialogue):
    history_content = ""
    for turn in dialogue:
        role = "ç”¨æˆ·" if turn.get("speaker") == "user" else "ç³»ç»Ÿ"
        content = turn.get("text", "").replace("\n", " ").strip()
        history_content += f"{role}ï¼š{content}\n"

    return history_content

async def query_once(session, url, payload):
    async with session.post(url, json=payload) as resp:
        data = await resp.json()
        return data["choices"][0]["message"]["content"].strip()


async def main(input_file):
    with open(input_file, "r", encoding="utf-8") as f:
        dataset = [json.loads(line) for line in f]

    url = "http://localhost:9000/v1/chat/completions"  # Ollama é»˜è®¤åœ°å€
    headers = {"Content-Type": "application/json"}
    
    payloads = []

    for item in dataset:
        full_input = build_user_input(item["dialogue"])
        prompt = global_prompt.substitute({"context":full_input, "text": item["final_query"]})
        print(len(prompt))
        payloads.append({
            "model": "glm",  # Ollama ä¸­çš„æ¨¡å‹å
            "messages": [
                {"role": "user", "content":prompt}
            ],
            "max_tokens": 256,
            "temperature": 0.3,
            "top_p": 0.9
        })

    start_time = time.time()
    async with aiohttp.ClientSession(headers=headers) as session:
        tasks = [query_once(session, url, p) for p in payloads]
        responses = await asyncio.gather(*tasks)

    for i, (res, item) in enumerate(zip(responses, dataset)):
        original_query = item["final_query"]
        print(f"[{i+1}]")
        print(f"ğŸ”¹ åŸé—®é¢˜ï¼š{original_query}")
        print(f"âœï¸ é‡å†™åï¼š{res}\n")


    end_time = time.time()
    print(f"\nâœ… å¹¶å‘å®Œæˆ {len(responses)} æ¡è¯·æ±‚ï¼Œè€—æ—¶: {end_time - start_time:.2f}s")


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--input_file", type=str, default="rewriting_test_set.jsonl", help="è¾“å…¥çš„ JSONL æ–‡ä»¶è·¯å¾„")
    args = parser.parse_args()

    asyncio.run(main(args.input_file))
